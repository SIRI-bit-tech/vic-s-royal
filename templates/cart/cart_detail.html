{% extends "base.html" %}
{% load static %}

{% block title %}Shopping Cart{% endblock %}

{% block extra_css %}
<link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
    .mdc-card {
        border-radius: 16px;
        transition: all 0.3s ease;
        width: 100%;
        max-width: 100%;
        overflow: hidden;
    }
    .cart-container {
        padding: 16px;
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
    }
    .cart-item {
        border-bottom: 1px solid #e5e7eb;
        padding: 16px 0;
        width: 100%;
    }
    .cart-item:last-child {
        border-bottom: none;
    }
    .cart-item-content {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    @media (min-width: 640px) {
        .cart-item-content {
            flex-direction: row;
            align-items: center;
        }
    }
    .product-image {
        width: 100px;
        height: 100px;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f9fafb;
    }
    .product-image img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        max-width: 100%;
        max-height: 100%;
    }
    .product-details {
        flex-grow: 1;
        min-width: 0; /* Prevents flex item from overflowing */
    }
    .product-title {
        font-size: 1.125rem;
        font-weight: 500;
        margin-bottom: 8px;
        word-wrap: break-word;
    }
    .price-quantity {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: center;
    }
    .quantity-input {
        width: 80px;
        text-align: center;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 8px;
    }
    .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .cart-summary {
        padding: 16px;
        background-color: #f9fafb;
        border-radius: 8px;
        margin-top: 16px;
    }
    .cart-total {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 16px;
    }
    .cart-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: space-between;
    }
    .empty-cart {
        text-align: center;
        padding: 32px 16px;
    }
    .empty-cart .material-icons {
        font-size: 48px;
        color: #9ca3af;
        margin-bottom: 16px;
    }
</style>
{% endblock %}

{% block content %}
<div class="cart-container">
    <h1 class="mdc-typography--headline4 mb-6">Shopping Cart</h1>

      {% if cart %}
        <div class="mdc-card">
            {% for item in cart %}
                <div class="cart-item" id="cart-item-{{ item.product.id }}" data-product-id="{{ item.product.id }}">
                    <div class="cart-item-content">
                        <div class="product-image">
                            <img src="{% if item.product.image %}{{ item.product.image.url }}{% else %}{% static 'img/no_image.png' %}{% endif %}"
                                 alt="{{ item.product.name }}">
                        </div>
                        <div class="product-details">
                            <h2 class="product-title">{{ item.product.name }}</h2>
                            <div class="price-quantity">
                                <div class="price">
                                    {% if item.product.on_sale and item.product.sale_price %}
                                        <span class="line-through text-gray-500">₦{{ item.product.price }}</span>
                                        <span class="text-red-500 font-bold">₦{{ item.price }}</span>
                                        <span class="text-green-600 text-sm">(-{{ item.product.discount_percentage }}%)</span>
                                    {% else %}
                                        <span class="font-bold">₦{{ item.price }}</span>
                                    {% endif %}
                                </div>
                                <div class="flex items-center gap-2">
                                    <form action="{% url 'cart:cart_decrease' item.product.id %}" method="post" class="cart-quantity-form" data-item-id="{{ item.product.id }}">
                                        {% csrf_token %}
                                        <button type="submit" class="mdc-icon-button material-icons text-gray-600 hover:text-red-500">
                                            remove_circle_outline
                                        </button>
                                    </form>
                                    <span class="quantity-display px-4 py-2 bg-gray-100 rounded" id="quantity-{{ item.product.id }}">{{ item.quantity }}</span>
                                    <form action="{% url 'cart:cart_increase' item.product.id %}" method="post" class="cart-quantity-form" data-item-id="{{ item.product.id }}">
                                        {% csrf_token %}
                                        <button type="submit" class="mdc-icon-button material-icons text-gray-600 hover:text-green-500">
                                            add_circle_outline
                                        </button>
                                    </form>
                                    <form action="{% url 'cart:cart_remove' item.product.id %}" method="post" class="cart-quantity-form" data-item-id="{{ item.product.id }}">
                                        {% csrf_token %}
                                        <button type="submit" class="mdc-icon-button material-icons text-red-500 hover:text-red-700">
                                            delete
                                        </button>
                                    </form>
                                </div>
                                <div class="mt-2">
                                    <span class="font-bold" id="item-total-{{ item.product.id }}">Total: ₦{{ item.total_price }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
            
            <div class="cart-summary">
                <div class="cart-total">
                    <span id="cart-total">Total: ₦{{ cart.get_total_price }}</span>
                    {% if cart.get_discount %}
                        <div class="text-green-600 text-sm">
                            <span class="material-icons align-middle">local_offer</span>
                            <span id="cart-discount">Discount: ₦{{ cart.get_discount }}</span>
                        </div>
                    {% endif %}
                </div>
                <div class="cart-buttons">
                    <a href="{% url 'products:product_list' %}" class="mdc-button mdc-button--outlined">
                        <span class="mdc-button__ripple"></span>
                        <span class="material-icons">arrow_back</span>
                        <span class="mdc-button__label">Continue Shopping</span>
                    </a>
                    <a href="{% url 'orders:order_create' %}" class="mdc-button mdc-button--raised">
                        <span class="mdc-button__ripple"></span>
                        <span class="material-icons">shopping_cart_checkout</span>
                        <span class="mdc-button__label">Checkout</span>
                    </a>
                </div>
            </div>
        </div>
      {% else %}
        <div class="mdc-card empty-cart">
            <span class="material-icons">shopping_cart</span>
            <p class="mdc-typography--body1 text-gray-600 mb-6">Your cart is empty.</p>
            <a href="{% url 'products:product_list' %}" class="mdc-button mdc-button--raised">
                <span class="mdc-button__ripple"></span>
                <span class="material-icons">shopping_bag</span>
                <span class="mdc-button__label">Start Shopping</span>
            </a>
        </div>
      {% endif %}
  </div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
<script>
    // WebSocket setup
    const cartSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/cart/'
    );

    cartSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.type === 'stock_update') {
            updateStockDisplay(data.product_id, data.stock);
        } else if (data.type === 'price_update') {
            updatePriceDisplay(data.product_id, data.price, data.sale_price, data.on_sale);
        } else if (data.type === 'cart_update') {
            updateCartDisplay(data.cart_data);
        }
    };

    cartSocket.onclose = function(e) {
        console.error('Cart socket closed unexpectedly');
    };

    // WebSocket functions
    function checkStock(productId) {
        cartSocket.send(JSON.stringify({
            'action': 'check_stock',
            'product_id': productId
        }));
    }

    function checkPrice(productId) {
        cartSocket.send(JSON.stringify({
            'action': 'check_price',
            'product_id': productId
        }));
    }

    function updateStockDisplay(productId, stock) {
        const stockElement = document.querySelector(`[data-stock-id="${productId}"]`);
        if (stockElement) {
            stockElement.textContent = `Stock: ${stock}`;
            if (stock <= 0) {
                const addButton = document.querySelector(`[data-add-id="${productId}"]`);
                if (addButton) {
                    addButton.disabled = true;
                    addButton.textContent = 'Out of Stock';
                }
            }
        }
    }

    function updatePriceDisplay(productId, price, salePrice, onSale) {
        const priceElement = document.querySelector(`[data-price-id="${productId}"]`);
        if (priceElement) {
            if (onSale && salePrice) {
                priceElement.innerHTML = `
                    <span class="original-price text-muted"><s>$${price}</s></span>
                    <span class="sale-price text-danger">$${salePrice}</span>
                `;
            } else {
                priceElement.textContent = `$${price}`;
            }
        }
    }

    // AJAX functions
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function updateCartDisplay(data) {
        // Update total price
        const cartTotalElement = document.getElementById('cart-total');
        if (cartTotalElement && data.cart_total_price) {
            cartTotalElement.textContent = `$${data.cart_total_price}`;
        }

        // Update item quantities and totals
        if (data.item_id) {
            const quantityElement = document.getElementById(`quantity-${data.item_id}`);
            const itemTotalElement = document.getElementById(`total-${data.item_id}`);
            
            if (quantityElement) {
                quantityElement.value = data.item_quantity;
            }
            if (itemTotalElement && data.item_total) {
                itemTotalElement.textContent = `$${data.item_total}`;
            }
        }

        // Update cart count
        const cartCountElement = document.getElementById('cart-count');
        if (cartCountElement && data.cart_total) {
            cartCountElement.textContent = data.cart_total;
        }

        // Update discount if applicable
        const discountElement = document.getElementById('cart-discount');
        if (discountElement && data.cart_discount) {
            discountElement.textContent = `$${data.cart_discount}`;
        }

        // Remove item if quantity is 0
        if (data.item_id && data.item_quantity === 0) {
            const cartItem = document.getElementById(`cart-item-${data.item_id}`);
            if (cartItem) {
                cartItem.remove();
            }
        }
    }

    // Handle cart form submissions
    document.querySelectorAll('.cart-quantity-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const itemId = this.dataset.itemId;

            fetch(this.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                updateCartDisplay(data);
                // Trigger WebSocket checks after cart update
                if (itemId) {
                    checkStock(itemId);
                    checkPrice(itemId);
                }
            });
        });
    });

    // Periodic stock and price checks
    function periodicCheck() {
        document.querySelectorAll('[data-product-id]').forEach(element => {
            const productId = element.dataset.productId;
            checkStock(productId);
            checkPrice(productId);
        });
    }

    // Run checks every 30 seconds
    setInterval(periodicCheck, 30000);
    
    // Initial check
    periodicCheck();
</script>
{% endblock %}